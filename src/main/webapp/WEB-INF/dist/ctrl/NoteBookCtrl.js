angular.module("myApp").controller("NoteBookCtrl",["$rootScope","$cookies","$scope","$location","$window","$routeParams","$http","$anchorScroll","$mdDialog",function(e,o,t,i,n,r,s,c,d){t.searchForm={pIdCode:r.pIdCode},t.notes=[],t.folderPath=[],t.folders=[];var l=o.get("ACNoteViewType");l?(t.viewType=l,"view_list"==t.viewType?t.viewTypeTip="切换到列表视图":t.viewTypeTip="切换到模块视图"):(t.viewType="view_list",t.viewTypeTip="切换到列表视图"),t.toggleView=function(){"view_list"==t.viewType?(t.viewType="view_module",t.viewTypeTip="切换到模块视图"):(t.viewType="view_list",t.viewTypeTip="切换到列表视图"),o.put("ACNoteViewType",t.viewType,{expires:new Date((new Date).getTime()+2592e6)})},t.selectItem=function(e,o){t.selectedItem=e,n.onclick=function(e){t.selectedItem=null,n.onclick=null,t.$apply()},o.stopPropagation()},t.isSelectedItem=function(e,o){return t.selectedItem?"file"==o?t.selectedItem.type&&"file"==t.selectedItem.type?t.selectedItem.idCode==e.idCode:!1:t.selectedItem.type&&"file"==t.selectedItem.type?!1:t.selectedItem.idCode==e.idCode:!1},t.clearSearch=function(){t.filter.show=!1,t.searchForm.title&&""!=t.searchForm.title&&(t.searchForm.title="",t.search(!1))},t.search=function(e){t.promise=s.post(ctx+"/notebook/search",t.searchForm).success(function(e){"success"==e.result?(t.notes=e.data.notes,t.folders=e.data.folders,t.folderPath=e.data.folderPath):t.$root.$broadcast("notify",{type:"error",title:"错误",info:e.info,timeOut:2e3})})},t.newNote=function(e){e.stopPropagation(),i.path("/notebookNew").search({idCode:"",pIdCode:t.searchForm.pIdCode})},t.uploadNote=function(e){d.show({templateUrl:"templates/notebook/upload.html?v="+sysVersion,controller:"NotebookUploadCtrl",fullscreen:!0,resolve:{data:function(){return{pIdCode:t.searchForm.pIdCode}}}}).then(function(e){t.search()})},t.toEdit=function(e){e.stopPropagation(),"file"==t.selectedItem.type?i.path("/notebookNew").search({pIdCode:t.searchForm.pIdCode,idCode:t.selectedItem.idCode}):t.newFolder({idCode:t.selectedItem.idCode,name:t.selectedItem.name})},t.del=function(e){var o=t.selectedItem;e.stopPropagation(),"file"==t.selectedItem.type?t.delNote(o):t.delFolder(o)},t.delNote=function(e){var o=d.confirm().title("确认删除笔记: "+e.title+" ?").textContent("删除后不可恢复").ariaLabel("确认").ok("确认").cancel("取消");d.show(o).then(function(){t.promise=s.post(ctx+"/notebook/delete",{idCode:e.idCode}).success(function(o){if("success"==o.result){t.$root.$broadcast("notify",{type:"success",title:"提示",info:"删除成功",timeOut:2e3});var i=t.notes.indexOf(e);i>-1&&t.notes.splice(i,1)}else t.$root.$broadcast("notify",{type:"error",title:"错误",info:o.info,timeOut:2e3})})})},t.delFolder=function(e){var o=d.confirm().title("确认删除文件夹: "+e.name+" ?").textContent("删除后不可恢复").ariaLabel("确认").ok("确认").cancel("取消");d.show(o).then(function(){t.promise=s.post(ctx+"/notebook/deleteFolder",{idCode:e.idCode}).success(function(o){if("success"==o.result){t.$root.$broadcast("notify",{type:"success",title:"提示",info:"删除成功",timeOut:2e3});var i=t.folders.indexOf(e);i>-1&&t.folders.splice(i,1)}else t.$root.$broadcast("notify",{type:"error",title:"错误",info:o.info,timeOut:2e3})})})},t.toFolder=function(e){i.path("/notebook").search({pIdCode:e})},t.openFolder=function(e){var o=t.selectedItem;e.stopPropagation(),i.path("/notebook").search({pIdCode:o.idCode})},t.newFolder=function(e){e||(e={}),e.pIdCode=t.searchForm.pIdCode,d.show({templateUrl:"templates/notebook/newFolder.html?v="+sysVersion,resolve:{folderParam:function(){return e}},controller:"NoteBookFolderCtrl"}).then(function(e){"success"==e&&t.search()})},t.search()}]),angular.module("myApp").controller("NoteBookNewCtrl",["$rootScope","$window","$scope","$location","$routeParams","$http","$anchorScroll",function(e,o,t,i,n,r,s){function c(){var e=o.innerHeight-130;t.aceheight={height:e+"px"},t.$apply()}var d=o.innerHeight-130;t.aceheight={height:d+"px"},angular.element(o).bind("resize",function(){this.resizeTO&&clearTimeout(this.resizeTO),this.resizeTO=setTimeout(function(){c()},50)}),t.editForm={pIdCode:n.pIdCode},t.aceEditorOptions={mode:"scheme",onLoad:function(e){e.$blockScrolling=1/0,e.setReadOnly(!1),e.setFontSize(15),t.aceSession=e.getSession()}},t.save=function(){t.promise=r.post(ctx+"/notebook/save",t.editForm).success(function(e){"success"==e.result?(t.$root.$broadcast("notify",{type:"success",title:"提示",info:"保存成功",timeOut:2e3}),i.path("/notebook").search({pIdCode:n.pIdCode})):t.$root.$broadcast("notify",{type:"error",title:"错误",info:e.info,timeOut:2e3})})},t.back=function(){i.path("/notebook").search({pIdCode:n.pIdCode})},n.idCode&&(t.promise=r.post(ctx+"/notebook/getDetailInfo",{idCode:n.idCode}).success(function(e){t.editForm=e.data}))}]),angular.module("myApp").controller("NoteBookFolderCtrl",["$mdDialog","$scope","$http","folderParam",function(e,o,t,i){o.editForm={pIdCode:i.pIdCode,name:i.name,idCode:i.idCode},o.dialogName="新文件夹",i.idCode&&""!=i.idCode&&(o.dialogName="重命名"),o.cancel=function(){e.cancel()},o.save=function(){o.promise=t.post(ctx+"/notebook/saveFolder",o.editForm).success(function(t){"success"==t.result?(o.$root.$broadcast("notify",{type:"success",title:"提示",info:"创建成功",timeOut:2e3}),e.hide("success")):o.$root.$broadcast("notify",{type:"error",title:"错误",info:t.info,timeOut:2e3})})}}]),angular.module("myApp").controller("NotebookUploadCtrl",["$rootScope","$scope","$http","$mdDialog","formDataObject","data",function(e,o,t,i,n,r){o.uploadInfo={},o.upload=function(){if(!o.uploadInfo.txtFile)return void o.$root.$broadcast("notify",{type:"error",title:"请先选择文件。",info:r.info,timeOut:2e3});if(o.uploadInfo.txtFile.size>1024e3)return void o.$root.$broadcast("notify",{type:"error",title:"文件大小必须在1M以内。",info:r.info,timeOut:2e3});var e={};e.pIdCode=r.pIdCode,e.txtFile=o.uploadInfo.txtFile;var s={method:"POST",url:ctx+"/notebook/upload",headers:{"Content-Type":void 0},data:e,transformRequest:n};o.promise=t(s).success(function(e){"success"==e.result?(o.$root.$broadcast("notify",{type:"success",title:"提示",info:"上传成功",timeOut:2e3}),i.hide("success")):o.$root.$broadcast("notify",{type:"error",title:"错误",info:e.info,timeOut:2e3})})},o.cancel=function(){i.cancel()}}]);