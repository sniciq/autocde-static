angular.module("myApp").controller("ProjectCtrl",["$rootScope","$scope","$location","$routeParams","$http","$mdDialog","MenuService",function(e,t,o,l,a,s,n){myApp.navNames["/project"]="配置项目",t.previewProjectCode=function(e){o.path("/project_code").search({id:e})},t.previewProject=function(e){window.open(ctx+"/preview?id="+e)},t.downloadProject=function(e){window.open(ctx+"/dowload?id="+e)},t.parseDBSQL=function(){s.show({templateUrl:"templates/project/data_table_parse.html?v="+sysVersion,controller:"DataTableSQLParseCtrl",fullscreen:!0,resolve:{data:function(){return{projectId:l.id}}}}).then(function(e){t.loadDataTable()})},t.importDataTable=function(){s.show({templateUrl:"templates/project/data_table_import.html?v="+sysVersion,controller:"DataTableImportCtrl",fullscreen:!0,resolve:{data:function(){return{projectId:l.id}}}}).then(function(e){t.loadDataTable()})},t.editDataTable=function(e){s.show({templateUrl:"templates/project/data_table.html?v="+sysVersion,controller:"DataTableCtrl",fullscreen:!0,resolve:{data:function(){return{projectId:t.projectInfo.id,dataTableId:e}}}}).then(function(e){t.loadDataTable()})},t.deleteDataTable=function(e){var o=s.confirm().title("确认").textContent("确认删除数据表: "+e.name+" ?").ariaLabel("确认").ok("确认").cancel("取消");s.show(o).then(function(){t.promise=a.post(ctx+"/basic/DataTableCtrl/delete",{id:e.id}).success(function(e){"success"==e.result?(t.$root.$broadcast("notify",{type:"success",title:"提示",info:"删除成功",timeOut:2e3}),t.loadDataTable()):t.$root.$broadcast("notify",{type:"error",title:"错误",info:e.info,timeOut:2e3})})})},t.loadProjectDetail=function(){t.promise=a.post(ctx+"/basic/project/getProjectDetail",{id:l.id}).success(function(e){"success"==e.result?(t.dataTableList=e.data.dataTableList,t.projectInfo=e.data.projectInfo,t.moduleMap=e.data.moduleMap,t.muduleNoGroupList=e.data.muduleNoGroupList):t.$root.$broadcast("notify",{type:"error",title:"错误",info:e.info,timeOut:2e3})})},t.loadDataTable=function(){t.promise=a.post(ctx+"/basic/DataTableCtrl/search",{projectId:t.projectInfo.id}).success(function(e){t.dataTableList=e.invdata})},t.loadModules=function(){t.promise=a.post(ctx+"/basic/ModuleCtrl/search",{projectId:t.projectInfo.id}).success(function(e){t.moduleMap=e.data.moduleMap,t.muduleNoGroupList=e.data.muduleNoGroupList})},t.deleteModule=function(e){var o=s.confirm().title("确认").textContent("确认删除数据表: "+e.name+" ?").ariaLabel("确认").ok("确认").cancel("取消");s.show(o).then(function(){t.promise=a.post(ctx+"/basic/ModuleCtrl/delete",{id:e.id}).success(function(e){"success"==e.result?(t.$root.$broadcast("notify",{type:"success",title:"提示",info:"删除成功",timeOut:2e3}),t.loadModules()):t.$root.$broadcast("notify",{type:"error",title:"错误",info:e.info,timeOut:2e3})})})},t.editModule=function(e){s.show({templateUrl:"templates/project/module.html?v="+sysVersion,controller:"ModuleCtrl",escapeToClose:!1,fullscreen:!0,clickOutsideToClose:!1,resolve:{data:function(){return{projectId:t.projectInfo.id,moduleId:e}}}}).then(function(e){t.loadModules()})},t.menus=[],t.newMenu=function(){t.menus.push({name:"",modules:[]})},t.loadProjectDetail()}]),angular.module("myApp").controller("DataTableCtrl",["$rootScope","$scope","$http","$mdDialog","$mdToast","data",function(e,t,o,l,a,s){null!=s.dataTableId&&s.dataTableId>0?t.promise=o.post(ctx+"/basic/DataTableCtrl/getDetail",{dataTableId:s.dataTableId}).success(function(e){t.dataTable=e.data.dataTable,t.dataTable.columns=e.data.columns}):t.dataTable={projectId:s.projectId,columns:[{name:""}]},t.addColumn=function(){t.dataTable.columns.push({name:"",type:""})},t.deleteColumn=function(e){t.dataTable.columns.splice(e,1)},t.save=function(){for(var e=0,a=0;a<t.dataTable.columns.length;a++)t.dataTable.columns[a].isPK&&e++;return 1!=e?void t.$root.$broadcast("notify",{type:"error",title:"请选择一个主键。",info:s.info,timeOut:2e3}):void(t.promise=o.post(ctx+"/basic/DataTableCtrl/save",t.dataTable).success(function(e){"success"==e.result?(t.$root.$broadcast("notify",{type:"success",title:"提示",info:"保存成功",timeOut:2e3}),l.hide("success")):t.$root.$broadcast("notify",{type:"error",title:"错误",info:e.info,timeOut:2e3})}))},t.cancel=function(){l.cancel()}}]),angular.module("myApp").controller("DataTableSQLParseCtrl",["$rootScope","$scope","$http","$mdDialog","$window","data",function(e,t,o,l,a,s){t.cancel=function(){l.cancel()},t.save=function(){t.promise=o.post(ctx+"/basic/DataTableCtrl/parseSql",{idCode:s.projectId,sql:t.sql}).success(function(e){"success"==e.result?(t.$root.$broadcast("notify",{type:"success",title:"提示",info:"导入成功",timeOut:2e3}),l.hide("success")):t.$root.$broadcast("notify",{type:"error",title:"错误",info:e.info,timeOut:2e3})})}}]),angular.module("myApp").controller("DataTableImportCtrl",["$rootScope","$scope","$http","$mdDialog","formDataObject","data",function(e,t,o,l,a,s){t.tableImport={projectIdCode:s.projectId,type:2},t["import"]=function(){if(2==t.tableImport.type&&!t.tableImport.sqlFile)return void t.$root.$broadcast("notify",{type:"error",title:"请先SQL选择文件。",info:s.info,timeOut:2e3});if(2==t.tableImport.type&&t.tableImport.sqlFile.size>1024e3)return void t.$root.$broadcast("notify",{type:"error",title:"文件大小必须在1M以内。",info:s.info,timeOut:2e3});s.formJsonData=angular.toJson(t.tableImport),s.sqlFile=t.tableImport.sqlFile;var e={method:"POST",url:ctx+"/basic/DataTableCtrl/importDB",headers:{"Content-Type":void 0},data:s,transformRequest:a};t.promise=o(e).success(function(e){"success"==e.result?(t.$root.$broadcast("notify",{type:"success",title:"提示",info:"导入成功",timeOut:2e3}),l.hide("success")):t.$root.$broadcast("notify",{type:"error",title:"错误",info:e.info,timeOut:2e3})})},t.cancel=function(){l.cancel()}}]),angular.module("myApp").controller("ModuleCtrl",["$rootScope","$scope","$http","$mdDialog","data",function(e,t,o,l,a){t.tableList=[],t.selectColumns=[],t.gridColumns=[],t.moduleTypeChange=function(){t.tableList=[],t.selectColumns=[],t.gridColumns=[],t.module.tables=[],t.module.selectColumns=[],t.module.gridColumns=[],t.module.relations=[],t.loadDatatables()},o.post(ctx+"/basic/ModuleCtrl/getModuleGroup",{projectId:a.projectId}).success(function(e){t.menuList=e.invdata}),t.loadDatatables=function(){o.post(ctx+"/basic/DataTableCtrl/search",{projectId:a.projectId}).success(function(e){t.tableList=[];for(var o=0;o<e.invdata.length;o++){for(var l=e.invdata[o],a=!1,s=0;s<t.module.tables.length;s++)if(t.module.tables[s]==l.id){a=!0;break}t.tableList.push({id:l.id,name:l.name,remark:l.remark,selected:a})}for(var n="",s=0;s<t.module.tables.length;s++)n+=t.module.tables[s]+",";t.loadColumsList(n)})},t.loadColumsList=function(e){o.post(ctx+"/basic/DataTableCtrl/getTableColumns",{tableIds:e}).success(function(e){if(1==t.module.type)t.selectColumns=e.data.columns,t.gridColumns=angular.copy(e.data.columns);else if(2==t.module.type)for(var o=0;o<e.data.columns.length;o++){var l=angular.copy(e.data.columns[o]),a=angular.copy(e.data.columns[o]);t.selectColumns.push(l),t.gridColumns.push(a)}for(var o=0;o<t.selectColumns.length;o++)for(var s=0;s<t.module.selectColumns.length;s++)if(t.selectColumns[o].id==t.module.selectColumns[s]){t.selectColumns[o].selected=!0;break}for(var o=0;o<t.gridColumns.length;o++)for(var s=0;s<t.module.gridColumns.length;s++)if(t.gridColumns[o].id==t.module.gridColumns[s]){t.gridColumns[o].selected=!0;break}t.optionAllSelectColumnsToggled(),t.optionAllGridColumnsToggled()})},t.tableItemClick=function(e){if(1==t.module.type&&(t.selectColumns=[],e.selected))for(var o=0;o<t.tableList.length;o++)t.tableList[o].id!=e.id&&(t.tableList[o].selected=!1,t.deleteCols(e.id));2!=t.module.type||e.selected||t.deleteCols(e.id),e.selected&&t.loadColumsList(e.id)},t.tableItemDelete=function(e){e.selected=!1,t.deleteCols(e.id)},t.deleteCols=function(e){t.module.selectColumns=[],t.module.gridColumns=[],t.module.tables=[];for(var o=t.selectColumns.length;o--;)t.selectColumns[o].datatableId==e&&t.selectColumns.splice(o,1),t.gridColumns[o].datatableId==e&&t.gridColumns.splice(o,1)},t.onModuleTypeChange=function(){t.selectColumns=[],t.gridColumns=[],t.module.relations=[],t.module.selectColumns=[],t.module.gridColumns=[],t.module.tables=[];for(var e=0;e<t.tableList.length;e++)t.tableList[e].selected=!1,t.deleteCols(t.tableList[e].id)},t.toggleAllSelectColumnsCheck=function(e){for(var o=0;o<t.selectColumns.length;o++)t.selectColumns[o].selected=e},t.optionAllSelectColumnsToggled=function(){t.isChkAllSelectColumns=t.selectColumns.every(function(e){return e.selected})},t.toggleAllGridColumnsCheck=function(e){for(var o=0;o<t.gridColumns.length;o++)t.gridColumns[o].selected=e},t.optionAllGridColumnsToggled=function(){t.isChkAllGridColumns=t.gridColumns.every(function(e){return e.selected})},t.save=function(){t.module.selectColumns=[];for(var e=0;e<t.selectColumns.length;e++)t.selectColumns[e].selected&&t.module.selectColumns.push(t.selectColumns[e].id);t.module.gridColumns=[];for(var e=0;e<t.gridColumns.length;e++)t.gridColumns[e].selected&&t.module.gridColumns.push(t.gridColumns[e].id);t.module.tables=[];for(var e=0;e<t.tableList.length;e++)t.tableList[e].selected&&t.module.tables.push(t.tableList[e].id);return 0==t.module.tables.length?void t.$root.$broadcast("notify",{type:"error",title:"数据表 必填。",info:a.info,timeOut:2e3}):0==t.module.selectColumns.length?void t.$root.$broadcast("notify",{type:"error",title:"查询项 必填。",info:a.info,timeOut:2e3}):0==t.module.gridColumns.length?void t.$root.$broadcast("notify",{type:"error",title:"显示项  必填。",info:a.info,timeOut:2e3}):void(t.promise=o.post(ctx+"/basic/ModuleCtrl/save",t.module).success(function(e){"success"==e.result?(t.$root.$broadcast("notify",{type:"success",title:"提示",info:"保存成功",timeOut:2e3}),l.hide("success")):t.$root.$broadcast("notify",{type:"error",title:"错误",info:e.info,timeOut:2e3})}))},t.cancel=function(){l.cancel()},t.addRelationColumn=function(){t.module.relations.push({})},t.deleteRelationColumn=function(e){t.module.relations.splice(e,1)},null!=a.moduleId&&a.moduleId>0?t.promise=o.post(ctx+"/basic/ModuleCtrl/getDetail",{id:a.moduleId}).success(function(e){t.module=e.data,t.loadDatatables()}):(t.module={projectId:a.projectId,type:1,hasAdd:1,hasDelete:1,tables:[],selectColumns:[],gridColumns:[],relations:[]},t.loadDatatables())}]);