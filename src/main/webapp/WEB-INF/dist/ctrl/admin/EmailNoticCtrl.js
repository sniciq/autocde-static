angular.module("myApp").controller("EmailNoticListCtrl",["$rootScope","$scope","$mdDialog","$http","$location","$anchorScroll",function(t,e,i,c,s,n){e.pagination={start:0,limit:10,sort:"id",dir:"desc",maxSize:8,currentPage:1,limitOptions:[10,20,50,100]},e.searchForm={extLimit:e.pagination},e.isLoading=!1,e.selectedItems={},e.search=function(){e.isLoading=!0,n("content"),c.post(ctx+"/admin/EmailNoticCtrl/search",e.searchForm).success(function(t){e.dataList=t,e.isLoading=!1})},e.pageChanged=function(){e.pagination.start=(e.pagination.currentPage-1)*e.pagination.limit,e.search()},e.clearSearch=function(){e.searchForm.searchParm="",e.search()},e.showSend=function(){if(1!=Object.keys(e.selectedItems).length)return!1;var t=Object.keys(e.selectedItems)[0],i=e.selectedItems[t];return 0==i.status},e.edit=function(){var c;if(0==Object.keys(e.selectedItems).length);else{if(1!=Object.keys(e.selectedItems).length)return void e.$root.$broadcast("notify",{type:"error",title:"错误",info:"请选中一个项目后再执行该操作！",timeOut:2e3});c=Object.keys(e.selectedItems)[0]}i.show({templateUrl:"templates/admin/EmailNoticEditTpl.html?v="+sysVersion,controller:"EmailNoticEditCtrl",clickOutsideToClose:!0,fullscreen:t.customFullscreen,resolve:{noticId:function(){return c}}}).then(function(t){"success"==t&&(e.search(),e.selectedItems={})})},e.send=function(t){if(1!=Object.keys(e.selectedItems).length)return void e.$root.$broadcast("notify",{type:"error",title:"错误",info:"请选中一个项目后再执行该操作！",timeOut:2e3});var s=Object.keys(e.selectedItems)[0],t=e.selectedItems[s],n=i.confirm().title("确认").textContent("确认发布: "+t.title+" ?").ariaLabel("确认").ok("确认").cancel("取消");i.show(n).then(function(){e.promise=c.post(ctx+"/admin/EmailNoticCtrl/sendEmail",{id:t.id}).success(function(t){"success"==t.result?(e.$root.$broadcast("notify",{type:"success",title:"提示",info:"邮件公告发布成功！",timeOut:2e3}),e.selectedItems={},e.search()):e.$root.$broadcast("notify",{type:"error",title:"错误",info:t.info,timeOut:2e3})})})},e.search()}]),angular.module("myApp").controller("EmailNoticEditCtrl",["$scope","$rootScope","$http","$mdDialog","noticId",function(t,e,i,c,s){t.tinymceOptions={onChange:function(t){},inline:!1,skin:"lightgray",theme:"modern"},t.updateHtml=function(){},t.showRcvSelector=!1,t.showCustomerSelector=function(){t.rcvSearch(),t.selectedUsers=angular.copy(t.inputForm.rcvList),t.showRcvSelector=!0},t.selectedUsers={},t.rcvPagination={start:0,limit:10,maxSize:8,currentPage:1,limitOptions:[10,20,50,100]},t.searchForm={extLimit:t.rcvPagination},t.rcvSearch=function(){t.promise=i.post(ctx+"/admin/AcUserCtrl/search",t.searchForm).success(function(e){t.rcvDataList=e;for(var i=!0,c=0;c<t.rcvDataList.invdata.length;c++){var s=t.rcvDataList.invdata[c];t.selectedUsers[s.id]?s.checked=!0:i=!1}t.allSelect=i})},t.rcvPageChanged=function(){t.rcvPagination.start=(t.rcvPagination.currentPage-1)*t.rcvPagination.limit,t.rcvSearch()},t.toggleSelectAll=function(){for(var e=0;e<t.rcvDataList.invdata.length;e++){var i=t.rcvDataList.invdata[e];i.checked=t.allSelect,delete t.selectedUsers[i.id],1==t.allSelect&&(t.selectedUsers[i.id]={userId:i.id,name:i.name,email:i.email})}},t.toggleSelectUser=function(e){e.checked?t.selectedUsers[e.id]={userId:e.id,name:e.name,email:e.email}:(delete t.selectedUsers[e.id],t.allSelect=!1)},t.selectRcvOK=function(){t.inputForm.rcvList=angular.copy(t.selectedUsers),t.showRcvSelector=!1},t.selectRcvCancel=function(){t.showRcvSelector=!1},t.removeRcv=function(e){delete t.inputForm.rcvList[e]},t.clearRcvs=function(){t.inputForm.rcvList={}},t.save=function(){t.promise=i.post(ctx+"/admin/EmailNoticCtrl/save",t.inputForm).success(function(e){"success"==e.result?(t.$root.$broadcast("notify",{type:"success",title:"提示",info:"操作成功",timeOut:2e3}),c.hide("success")):(t.$root.$broadcast("notify",{type:"error",title:"错误",info:e.info,timeOut:2e3}),c.hide("success"))})},t.cancel=function(){c.cancel()},void 0!=s?t.promise=i.post(ctx+"/admin/EmailNoticCtrl/getDetailInfo",{id:s}).success(function(e){t.inputForm={id:e.data.id,title:e.data.title,content:e.data.content,rcvList:e.data.rcvList},t.noticMailStatus=e.data.status,0!=t.noticMailStatus&&0==Object.keys(t.inputForm.rcvList).length&&(t.showAll=!0)}):(t.inputForm={rcvList:{}},t.noticMailStatus=0)}]);