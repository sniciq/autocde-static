(function() {
    tinymce.create('tinymce.plugins.ImageUploadPlugin', {
        init : function(ed, url) {
            url = tinyMCE.activeEditor.getParam('imageupload_rel') || url;
            var imageUploadUrl = tinyMCE.activeEditor.getParam('imageupload_url');
            var imageNavUrl = tinyMCE.activeEditor.getParam('imageNavUrl');
            var head = document.getElementsByTagName('body')[0];
            var css = document.createElement('link');                       
            css.type = 'text/css';
            css.rel = 'stylesheet';
            css.href = url + '/css/style.css';
            head.appendChild(css);
            
            // Register commands
            ed.addCommand('mceImageUpload', function() {
                $('#image_upload_type').val('tinymce'); 
                $('body').append('<div class="imageUploadBg"></div>');
                
                var showImageUploadError = function(msg) {
                    $('.imageUploadError').html(msg).show();
                    removeForeground();
                };
                
                var removeForeground = function() {
                    $('.imageUploadFg').remove();
                    $('.imageUploadFgLoading').remove();
                };
                
                var removeBackground = function() {
                    $('.imageUploadBg').remove();
                    $('.winContainer').remove();
                };
                
                var container = '\
                    <div class="winContainer">\
                        <div class="modal-header">\
                			<div class="row">\
                                <div class="col-sm-7"><h4 class="modal-title">图片管理</h4></div>\
                				<div class="col-sm-5"><button type="button" class="close mce-close" ng-click="cancel()"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button></div>\
                            </div>\
                         </div>\
                        <div class="modal-body">\
		                	<div class="panel panel-default">\
		                	  <div class="panel-heading">上传新图片</div>\
		                	  <div class="panel-body">\
			                	<div class="row">\
					 				<div class="form-group form-group-sm">\
					 					<label class="col-md-2 control-label">选择上传的文件 ：</label>\
					 					<div class="col-md-5">\
					 						<input type="file" class="form-control" name="file" id="image-upload-area">\
					 					</div>\
					 					<div class="col-md-5">\
					 						<button class="btn btn-primary" id="imageUploadSubmit">上传</button>\
					 					</div>\
					 				</div>\
				                </div>\
		                	  </div>\
		                	</div>\
		                	<div class="panel panel-default">\
			              	  <div class="panel-heading">选择图片</div>\
			              	  <div class="panel-body">\
			                	<div class="row" id="imgFinder">\
			    	 			</div>\
		                	  </div>\
                			  <div class="panel-footer">\
                				<button class="btn btn-primary" id="btn_insertSelect">插入</button>\
                			  </div>\
		                	</div>\
                        </div>\
                    </div>\
                ';
                
                $('body').append(container);
                
                $('.imageUploadBg, .winContainer .imageUploadClose, .mce-close').on('click', function(){
                    removeForeground();
                    removeBackground();
                });
                
                //得到文件列表
                $.ajax({
                    url: imageNavUrl,
                    cache: false,
                    contentType: false,
                    processData: false,
                    type: 'POST',
                    success: function(response){
                    	var html = '';
                    	for(var i = 0; i < response.invdata.length; i++) {
                    		var item = response.invdata[i];
                    		html += '<div class="imageupload-thumb"><div><img src="'+item.path+'&thum=true" style="width:120px;height:120px"></div><div><a style="display:block;height:20px;width:100px;word-wrap:break-word; word-break:break-all;" target="_blank" href="'+item.path+'">'+item.name+'</a></div></div>';
                    	}
                    	$('#imgFinder').html(html);
                    	
                    	$('.imageupload-thumb').on('click', function() {
                    		$('.imageupload-thumb').removeClass('imageupload-thumb-select');
                    		$(this).addClass('imageupload-thumb-select');
                    	})
                    }
                });
                
                $('#imageUploadSubmit').on('click', function(){
                    $('.imageUploadError').html('').hide();
                    if ($('#image-upload-area').val() != '') {
                        $('body').append('<div class="imageUploadFg"></div>');
                        $('body').append('<div class="imageUploadFgLoading"></div>');
                        
                        var data = new FormData();
                        data.append('img', $('#image-upload-area')[0].files[0]);
                        $.ajax({
                            url: imageUploadUrl,
                            data: data,
                            cache: false,
                            contentType: false,
                            processData: false,
                            type: 'POST',
                            success: function(response){
                            	if (!response || response.result != 'success') {
                            		removeForeground();
                            		showImageUploadError(response.info);
                            	} 
                            	else {
                            	    var tpl = '<img src="%s" />';
                            	    ed.insertContent(tpl.replace('%s', response.path));
                            	    ed.focus();
                            	    removeForeground();
                            	    removeBackground();
                            	}
                            }
                        });
                    } else {
                        showImageUploadError('Please select an image to upload.');
                    }
                });
                
                $('#btn_insertSelect').on('click', function() {
                	var slt = $('.imageupload-thumb-select');
                	if(slt.length == 0) {
                		return;
                	}
                	
                	var tpl = '<img src="%s" />';
            	    ed.insertContent(tpl.replace('%s', slt.find('a').attr('href')));
            	    ed.focus();
            	    removeForeground();
            	    removeBackground();
                });
            });

            // Register buttons
            ed.addButton('imageupload', {
                title : 'Image Upload',
                cmd : 'mceImageUpload',
                image : url + '/img/icon.png'
            });
        },

        getInfo : function() {
            return {
                longname : 'Image Upload',
                author : 'BoxUK',
                authorurl : 'https://github.com/boxuk/tinymce-imageupload',
                infourl : 'https://github.com/boxuk/tinymce-imageupload/blob/master/README.md',
                version : '1.0.0'
            };
        }
    });

    tinymce.PluginManager.add('imageupload', tinymce.plugins.ImageUploadPlugin);
})();